<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rewise | Focus</title>
    <style>
      :root {
        --primary: #4f46e5;
        --bg-body: #f1f5f9;
        --bg-sidebar: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --success: #10b981;
        --danger: #ef4444;
        --sidebar-width: 350px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* LAYOUT */
      .app-container {
        display: grid;
        grid-template-columns: var(--sidebar-width) 1fr;
        height: 100%;
        overflow: hidden;
      }
      @media (max-width: 800px) {
        .app-container {
          grid-template-columns: 1fr;
        }
        .sidebar {
          display: none;
        }
        .mobile-menu-btn {
          display: block !important;
        }
        .control-bar {
          padding: 12px 15px !important;
        }
        .action-btns button {
                margin-bottom: 10px;
                display: block;
        }
        .c-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
                    .control-bar {
                padding: 18px 4px !important;
            }
            .btn-mic {
                margin: 0 10px;
            }
            .c-btn.c-btn-main {
                min-width: auto;
                padding: 10px;
            }
      }

      /* SIDEBAR */
      .sidebar {
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        height: 100%;
        z-index: 20;
      }
      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        background: #f8fafc;
        flex-shrink: 0;
      }
      .sidebar-title {
            padding: 10px 0;
      }
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        min-height: 0;
      }

      .btn-action {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-action:hover {
        background: #f1f5f9;
      }
      .btn-action.primary {
        background: #eef2ff;
        color: var(--primary);
        border-color: #c7d2fe;
      }
      .deck-card {
        background: white;
        border: 1px solid var(--border);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: 0.1s;
      }
      .deck-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }
      .deck-name {
        font-weight: 700;
        font-size: 0.95rem;
      }
      .deck-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .deck-actions {
        display: flex;
        gap: 6px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #f1f5f9;
      }
      .icon-btn {
        flex: 1;
        border: none;
        background: #f8fafc;
        color: var(--text-muted);
        border-radius: 4px;
        padding: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        font-weight: 600;
      }
      .icon-btn:hover {
        background: #e2e8f0;
        color: var(--text-main);
      }
      .nav-back {
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        padding: 5px 0;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .question-item {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 4px;
        cursor: pointer;
        border: 1px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
      }
      .question-item:hover {
        background: #f8fafc;
        border-color: var(--border);
      }
      .question-item.active {
        background: #eef2ff;
        border-color: #c7d2fe;
        color: var(--primary);
        font-weight: 600;
      }
      .badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
        min-width: 40px;
        text-align: center;
      }
      .badge-none {
        background: #f1f5f9;
        color: #94a3b8;
      }
      .badge-good {
        background: #dcfce7;
        color: #166534;
      }
      .badge-bad {
        background: #fee2e2;
        color: #991b1b;
      }

      /* MAIN PANE */
      .main-pane {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow-y: auto;
        background: #f8fafc;
        position: relative;
      }
      .top-bar {
        background: white;
        padding: 15px 30px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 30;
      }
      .brand {
        font-weight: 900;
        font-size: 1.2rem;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .mode-switch {
        background: #e2e8f0;
        padding: 4px;
        border-radius: 8px;
        display: flex;
      }
      .mode-btn {
        padding: 6px 14px;
        border: none;
        background: transparent;
        font-weight: 600;
        color: #64748b;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: 0.2s;
      }
      .mode-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      /* WORKSPACE */
      .workspace {
        max-width: 800px;
        margin: 30px auto;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding-bottom: 50px;
      }
      .card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .prompt-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        background: #ffffff;
      }
      .prompt-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--primary);
        font-weight: 800;
        margin-bottom: 10px;
      }
      .prompt-text {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--text-main);
        line-height: 1.5;
      }

      /* --- TARGET CONTAINER (No Jump Fix) --- */
      .target-container {
        position: relative;
        width: 100%;
        border-bottom: 1px solid var(--border);
      }

      textarea {
        width: 100%;
        padding: 24px;
        border: none;
        font-family: inherit;
        font-size: 1rem;
        line-height: 1.6;
        resize: vertical;
        min-height: 140px;
        outline: none;
        background: #ffffff;
        color: var(--text-main);
        transition: background 0.2s;
        display: block;
      }
      textarea:disabled {
        background: #f8fafc;
        color: #cbd5e1;
      }

      /* The Overlay (Curtain) */
      .target-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        user-select: none;
        backdrop-filter: blur(4px);
        z-index: 5;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .target-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .target-overlay:hover {
        color: var(--primary);
        background: #f1f5f9;
      }

      /* CONTROLS */
      .control-bar {
        padding: 15px 24px;
        background: #ffffff;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .ctrl-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .c-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: 0.1s;
      }
      .c-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .c-btn:hover:not(:disabled) {
        transform: translateY(-1px);
      }
      .c-btn-main {
        background: var(--primary);
        color: white;
        min-width: 140px;
      }
      .c-btn-sec {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-main);
      }
      .c-btn-nav {
        padding: 8px;
        background: transparent;
        color: var(--text-muted);
        font-size: 1.2rem;
      }

      .btn-mic {
        width: 45px;
        height: 45px;
        padding: 0;
        background: white;
        color: white;
        border-radius: 50%;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .btn-mic.recording {
        border-width: 4px;
        border-color: red;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
      }

      /* RECALL & DIFF */
      .recall-area {
        min-height: 180px;
        position: relative;
        background: #fcfcfc;
      }
      #recall-input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
      }
      .diff-view {
        padding: 24px;
        line-height: 1.6;
        font-size: 1rem;
        display: none;
        white-space: pre-wrap;
      }
      .diff-view.active {
        display: block;
      }
      .diff-correct { background: #dcfce7; color: #15803d; padding: 2px 4px; border-radius: 4px; }
      .diff-missing { background: #fee2e2; color: #b91c1c; padding: 2px 4px; border-radius: 4px; text-decoration: line-through; opacity: 0.8; }
      .diff-extra { background: #fef9c3; color: #854d0e; text-decoration: underline; padding: 2px 4px; }
      .score-pill {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 1.5rem;
        font-weight: 800;
        opacity: 0;
        transform: scale(0.9);
        transition: all 0.3s;
      }
      .score-pill.visible {
        opacity: 1;
        transform: scale(1);
      }

      /* HISTORY */
      .history-container {
        display: none;
      }
      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .hist-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        font-size: 0.9rem;
        border: 1px solid var(--border);
      }
      .hist-table th,
      .hist-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      .hist-table th {
        background: #f8fafc;
        color: var(--text-muted);
      }

      /* MODALS */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }
      .modal {
        background: white;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 20px;
        overflow-y: auto;
      }
      .modal-footer {
        padding: 20px;
        border-top: 1px solid var(--border);
        background: #f9fafb;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-radius: 0 0 12px 12px;
      }
      .catalog-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .catalog-item {
        border: 1px solid var(--border);
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        background: #fafafa;
        transition: 0.1s;
      }
      .catalog-item:hover {
        border-color: var(--primary);
        background: #fff;
        transform: translateY(-2px);
      }
      .rev-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .rev-table td {
        padding: 8px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <!-- SIDEBAR -->
      <div class="sidebar" id="sidebar">
        <!-- View 1: LIBRARY -->
        <div
          id="view-library"
          style="display: flex; flex-direction: column; height: 100%"
        >
          <div class="sidebar-header">
            <div class="sidebar-title">My Deck Library</div>
            <button class="btn-action primary" onclick="app.openUploadModal()">
              + Create / Import Deck
            </button>
            <button class="btn-action" onclick="app.openCatalogModal()">
              Browse Catalog
            </button>
          </div>
          <div class="sidebar-content" id="list-decks"></div>
        </div>

        <!-- View 2: ACTIVE DECK -->
        <div
          id="view-deck"
          style="display: none; flex-direction: column; height: 100%"
        >
          <div class="sidebar-header">
            <div class="nav-back" onclick="app.showLibrary()">
              ‚Üê Back to Library
            </div>
            <div
              style="font-weight: 800; font-size: 1rem; color: var(--text-main); margin-bottom: 4px;"
              id="active-title"
            >
              Deck Name
            </div>
            <div
              class="sidebar-title"
              style="margin-bottom: 0; text-transform: none; font-weight: 400"
            >
              Progress: <span id="deck-progress">0/0</span>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px">
              <button class="icon-btn" onclick="app.viewActiveRevision()">
                View List
              </button>
              <button class="icon-btn" onclick="app.shareActiveDeck()">
                üîó Share
              </button>
            </div>
          </div>
          <div class="sidebar-content" id="list-questions"></div>
        </div>
      </div>

      <!-- MAIN PANE -->
      <div class="main-pane">
        <div class="top-bar">
          <button
            class="mobile-menu-btn"
            onclick="document.getElementById('sidebar').style.display = document.getElementById('sidebar').style.display==='none'?'flex':'none'"
          >
            ‚ò∞
          </button>
          <div class="brand">üß† Rewise</div>
          <div class="mode-switch">
            <button
              class="mode-btn active"
              id="mode-single"
              onclick="app.setMode('single')"
            >
              Single
            </button>
            <button
              class="mode-btn"
              id="mode-bulk"
              onclick="app.setMode('bulk')"
            >
              Bulk Deck
            </button>
          </div>
        </div>

        <div class="workspace">
          <div class="card">
            <!-- 1. Prompt -->
            <div class="prompt-header">
              <div class="prompt-label">
                <span id="prompt-label">PROMPT</span>
              </div>
              <div class="prompt-text" id="prompt-display">Loading...</div>
            </div>

            <!-- 2. Target Container (The "No Jump" Fix) -->
            <div class="target-container">
                <!-- The Actual Input (Always determines height) -->
                <textarea id="target-input" placeholder="Enter target answer here..."></textarea>
                
                <!-- The Overlay (Covers input when Hidden) -->
                <div class="target-overlay" id="target-overlay" onclick="app.peekTarget()">
                    Target Hidden (Click to Peek)
                </div>
            </div>

            <!-- 3. Controls -->
            <div class="control-bar">
              <div class="ctrl-group">
                <button
                  class="c-btn c-btn-nav"
                  id="btn-prev"
                  onclick="app.prevCard()"
                  title="Previous"
                >
                  ‚óÄ
                </button>
                <button
                  class="c-btn c-btn-sec"
                  id="btn-reset"
                  onclick="app.resetAction()"
                >
                  Reset
                </button>
                <button
                  class="c-btn c-btn-sec"
                  id="btn-edit"
                  onclick="app.editTarget()"
                >
                  Edit
                </button>
              </div>

              <button class="btn-mic" id="btn-mic" title="Toggle Mic">
                üéôÔ∏è
              </button>

              <div class="ctrl-group">
                <button
                  class="c-btn c-btn-main"
                  id="btn-main"
                  onclick="app.cycleAction()"
                >
                  Start Recall
                </button>
                <button
                  class="c-btn c-btn-nav"
                  id="btn-next"
                  onclick="app.nextCard()"
                  title="Next"
                >
                  ‚ñ∂
                </button>
              </div>
            </div>

            <!-- 4. Recall -->
            <div class="recall-area">
              <textarea
                id="recall-input"
                placeholder="Type or speak your answer here..."
              ></textarea>
              <div id="diff-view" class="diff-view"></div>
              <div id="score-pill" class="score-pill"></div>
            </div>
          </div>

          <!-- Single Mode History -->
          <div class="history-container" id="history-container">
            <div class="history-header">
              <strong>Session History</strong>
              <button
                onclick="app.clearHistory()"
                style="
                  color: var(--danger);
                  background: none;
                  border: none;
                  cursor: pointer;
                  font-weight: 600;
                "
              >
                Clear All
              </button>
            </div>
            <table class="hist-table">
                    <thead>
        <tr>
            <th style="width: 50px;">#</th>
            <th style="width: 140px;">Date & Time</th>
            <th>Target Preview</th>
            <th>Score</th>
            <th style="text-align: right;">Actions</th>
        </tr>
    </thead>
              <tbody id="history-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: UPLOAD -->
    <div class="modal-overlay" id="upload-modal">
      <div class="modal">
        <div class="modal-header">
          <h3>üìÇ Create / Import Deck</h3>
          <button
            onclick="app.closeModals()"
            style="
              border: none;
              background: none;
              font-size: 1.5rem;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <label style="font-weight: 600; font-size: 0.9rem">Deck Name</label>
          <input
            type="text"
            id="upload-name"
            placeholder="e.g. History Chapter 1"
          />
          <label style="font-weight: 600; font-size: 0.9rem"
            >JSON Data (Paste here)</label
          >
          <textarea
            id="upload-text"
            rows="8"
            style="
              width: 100%;
              border: 1px solid var(--border);
              background: #f9fafb;
              padding: 10px;
              font-family: monospace;
            "
            placeholder='[{"prompt":"Question 1", "target":"Answer 1"}, ...]'
          ></textarea>
        </div>
        <div class="modal-footer">
          <button class="c-btn c-btn-sec" onclick="app.closeModals()">
            Cancel
          </button>
          <button class="c-btn c-btn-main" onclick="app.processUpload()">
            Save Deck
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: CATALOG -->
    <div class="modal-overlay" id="catalog-modal">
      <div class="modal">
        <div class="modal-header">
          <h3>Global Deck Catalog</h3>
          <button
            onclick="app.closeModals()"
            style="
              border: none;
              background: none;
              font-size: 1.5rem;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px">
            Select a deck to import it into your library.
          </p>
          <div class="catalog-grid" id="catalog-list"></div>
        </div>
        <div class="modal-footer">
          <button class="c-btn c-btn-sec" onclick="app.closeModals()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: REVISION -->
    <div class="modal-overlay" id="revision-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="rev-title" style="margin: 0">Review</h3>
          <button
            onclick="app.closeModals()"
            style="
              border: none;
              background: none;
              font-size: 1.5rem;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <div class="modal-body">
          <table class="rev-table">
            <tbody id="rev-body"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="c-btn c-btn-sec" onclick="app.closeModals()">
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      /**
       * Rewise v14 - STABLE
       */

      const INTERNAL_CATALOG = [
        {
          name: "US Capitals",
          data: [
            { prompt: "California", target: "Sacramento" },
            { prompt: "Texas", target: "Austin" },
            { prompt: "New York", target: "Albany" },
            { prompt: "Florida", target: "Tallahassee" },
          ],
        },
        {
          name: "Basic Math",
          data: [
            { prompt: "12 * 12", target: "144" },
            { prompt: "Square root of 81", target: "9" },
            { prompt: "Pi (2 decimals)", target: "3.14" },
            { prompt: "10 ^ 3", target: "1000" },
          ],
        },
        {
          name: "Biology 101",
          data: [
            { prompt: "Powerhouse of the cell", target: "Mitochondria" },
            {
              prompt: "Process plants use to make food",
              target: "Photosynthesis",
            },
            { prompt: "Basic unit of life", target: "Cell" },
          ],
        },
        {
          name: "Web Dev Basics",
          data: [
            { prompt: "HTML stands for", target: "HyperText Markup Language" },
            { prompt: "CSS stands for", target: "Cascading Style Sheets" },
            { prompt: "JS stands for", target: "JavaScript" },
          ],
        },
      ];

      const app = {
        ALLOW_PEEK: false, // Set to false to disable peeking entirely

        mode: "single",
        state: "SETUP",
        library: [],
        activeDeck: null,
        currentCardIndex: -1,
        recognition: null,
        isRecording: false,

        el: {
          sidebarLib: document.getElementById("view-library"),
          sidebarDeck: document.getElementById("view-deck"),
          listDecks: document.getElementById("list-decks"),
          listQuestions: document.getElementById("list-questions"),

          promptDisplay: document.getElementById("prompt-display"),
          targetInput: document.getElementById("target-input"),
          targetOverlay: document.getElementById("target-overlay"),
          recallInput: document.getElementById("recall-input"),
          diffView: document.getElementById("diff-view"),
          scorePill: document.getElementById("score-pill"),

          btnMain: document.getElementById("btn-main"),
          btnReset: document.getElementById("btn-reset"),
          btnEdit: document.getElementById("btn-edit"),
          btnMic: document.getElementById("btn-mic"),
          btnPrev: document.getElementById("btn-prev"),
          btnNext: document.getElementById("btn-next"),

          modeSingle: document.getElementById("mode-single"),
          modeBulk: document.getElementById("mode-bulk"),

          mUpload: document.getElementById("upload-modal"),
          mRev: document.getElementById("revision-modal"),
          mCat: document.getElementById("catalog-modal"),
        },

        init() {
          this.loadLibrary();
          this.loadHistory(); // Load history on startup
          this.initSpeech();

          // Load Single Mode Draft
          const savedDraft = localStorage.getItem("recall_single_draft");
          if (savedDraft) {
            this.el.targetInput.value = savedDraft;
          }

          // Auto-Save Listener
          this.el.targetInput.addEventListener("input", (e) => {
            if (this.mode === "single") {
              localStorage.setItem("recall_single_draft", e.target.value);
            }
          });

          if (!this.checkForURLImport()) {
            this.setMode("single");
          }
          this.updatePeek();
        },

        // --- LIBRARY SYSTEM ---
        loadLibrary() {
          const raw = localStorage.getItem("recall_lib_final");
          this.library = raw ? JSON.parse(raw) : [];
          this.renderDeckList();
        },
        saveLibrary() {
          localStorage.setItem("recall_lib_final", JSON.stringify(this.library));
        },

        renderDeckList() {
          this.el.listDecks.innerHTML = "";
          if (this.library.length === 0) {
            this.el.listDecks.innerHTML =
              '<div style="text-align:center;color:#94a3b8;padding:30px;">Library Empty.<br>Click "+ Create" or<br>"Browse Catalog"</div>';
            return;
          }
          this.library.forEach((d) => {
            const isGlobal = !!d.filename;
            const shareBtnLabel = isGlobal ? "Link" : "JSON";
            const shareAction = isGlobal
              ? `app.shareDeck(${d.id})`
              : `app.exportDeck(${d.id})`;

            const div = document.createElement("div");
            div.className = "deck-card";
            div.innerHTML = `
                <div class="deck-info" onclick="app.openDeck(${d.id})">
                    <div class="deck-name">${d.name}</div>
                    <div class="deck-meta">${d.cards.length} Cards ${
              isGlobal ? "‚Ä¢ Global" : "‚Ä¢  User"
            }</div>
                </div>
                <div class="deck-actions">
                    <button class="icon-btn btn-play" onclick="app.openDeck(${
                      d.id
                    })">Play</button>
                    <button class="icon-btn" onclick="app.viewRevision(${
                      d.id
                    })">View</button>
                    <button class="icon-btn" onclick="${shareAction}">${shareBtnLabel}</button>
                    <button class="icon-btn btn-del" onclick="app.deleteDeck(${
                      d.id
                    })">Delete</button>
                </div>
            `;
            this.el.listDecks.appendChild(div);
          });
        },

        createDeck(name, rawCards, filename = null) {
          try {
            const cards = rawCards.map((x, i) => ({
              id: i,
              prompt: x.prompt || x.p || "Q" + (i + 1),
              target: x.target || x.t || "",
              score: null,
            }));

            if (!cards.length) throw new Error("Deck is empty");

            const newDeck = {
              id: Date.now(),
              name: name || "Untitled Deck",
              cards,
              filename: filename,
            };

            this.library.unshift(newDeck);
            this.saveLibrary();
            this.renderDeckList();
            this.closeModals();
            return newDeck.id;
          } catch (e) {
            alert("Error creating deck: " + e.message);
            return null;
          }
        },

        deleteDeck(id) {
          if (!confirm("Delete this deck?")) return;
          this.library = this.library.filter((d) => d.id !== id);
          this.saveLibrary();
          if (this.activeDeck && this.activeDeck.id === id) this.showLibrary();
          else this.renderDeckList();
        },

        // --- NAVIGATION LOGIC ---
        showLibrary() {
          this.activeDeck = null;
          this.el.sidebarLib.style.display = "flex";
          this.el.sidebarDeck.style.display = "none";
          this.renderDeckList();
          this.el.promptDisplay.textContent = "Select a deck.";
          this.resetAction();
        },

        openDeck(id) {
          this.activeDeck = this.library.find((d) => d.id === id);
          this.el.sidebarLib.style.display = "none";
          this.el.sidebarDeck.style.display = "flex";
          document.getElementById("active-title").textContent =
            this.activeDeck.name;
          this.setMode("bulk");
          this.loadCard(0);
          this.renderQuestionList();
        },

        setMode(m) {
          this.mode = m;
          this.el.modeSingle.className =
            m === "single" ? "mode-btn active" : "mode-btn";
          this.el.modeBulk.className =
            m === "bulk" ? "mode-btn active" : "mode-btn";

          const isBulk = m === "bulk";
          const sidebar = document.getElementById("sidebar");

          if (window.innerWidth > 800) {
            sidebar.style.display = isBulk ? "flex" : "none";
            document.querySelector(".app-container").style.gridTemplateColumns =
              isBulk ? "350px 1fr" : "1fr";
          } else {
            sidebar.style.display = "none";
          }

          document.getElementById("history-container").style.display = isBulk
            ? "none"
            : "block";
          this.el.btnPrev.style.display = isBulk ? "inline-flex" : "none";
          this.el.btnNext.style.display = isBulk ? "inline-flex" : "none";

          if (m === "single") {
            document.getElementById("prompt-label").textContent =
              "SINGLE ENTRY";
            this.el.promptDisplay.textContent = "Single Entry Mode";
            this.el.targetInput.value = localStorage.getItem("recall_single_draft") || "";
            this.resetAction();
          } else {
            document.getElementById("prompt-label").textContent = "DECK CARD";
            if (this.activeDeck) this.loadCard(this.currentCardIndex);
            else if (this.library.length === 0) this.showLibrary();
          }
        },

        // --- CARD LOGIC ---
        renderQuestionList() {
          if (!this.activeDeck) return;
          const list = this.el.listQuestions;
          list.innerHTML = "";

          const completed = this.activeDeck.cards.filter(
            (c) => c.score !== null
          ).length;
          document.getElementById(
            "deck-progress"
          ).textContent = `${completed}/${this.activeDeck.cards.length}`;

          this.activeDeck.cards.forEach((c, idx) => {
            const div = document.createElement("div");
            div.className = `question-item ${
              idx === this.currentCardIndex ? "active" : ""
            }`;
            div.onclick = () => this.loadCard(idx);

            let bClass = "badge-none",
              bText = "-";
            if (c.score !== null) {
              bClass = c.score >= 80 ? "badge-good" : "badge-bad";
              bText = c.score + "%";
            }

            div.innerHTML = `<span>${idx + 1}. ${
              c.prompt
            }</span> <span class="badge ${bClass}">${bText}</span>`;
            list.appendChild(div);
          });
        },

        loadCard(idx) {
          if (
            !this.activeDeck ||
            idx < 0 ||
            idx >= this.activeDeck.cards.length
          )
            return;

          this.stopMic();
          this.currentCardIndex = idx;
          const c = this.activeDeck.cards[idx];

          this.el.promptDisplay.textContent = c.prompt;
          this.el.targetInput.value = c.target;

          // If Bulk Mode, go straight to RECALL (Hidden)
          this.setState(this.mode === "bulk" ? "RECALL" : "SETUP");

          this.el.recallInput.value = "";
          this.el.diffView.innerHTML = "";
          this.el.scorePill.classList.remove("visible");
          this.renderQuestionList();

          if (this.mode === "bulk")
            setTimeout(() => this.el.recallInput.focus(), 50);
        },

        nextCard() {
          if (this.currentCardIndex < this.activeDeck.cards.length - 1)
            this.loadCard(this.currentCardIndex + 1);
          else alert("End of deck reached.");
        },
        prevCard() {
          if (this.currentCardIndex > 0)
            this.loadCard(this.currentCardIndex - 1);
        },

        // --- ACTION CYCLE ---
        cycleAction() {
          if (this.state === "SETUP") {
            if (this.mode === "single" && !this.el.targetInput.value.trim())
              return alert("Enter target text.");
            if (this.mode === "bulk" && !this.activeDeck)
              return alert("Select a deck first.");

            this.setState("RECALL");
            this.el.recallInput.focus();
          } else if (this.state === "RECALL") {
            if (!this.el.recallInput.value.trim())
              return alert("Enter your answer.");
            this.stopMic();
            this.calculateScore();
            this.setState("REVIEW");
          } else if (this.state === "REVIEW") {
            if (this.mode === "bulk") this.nextCard();
            else this.resetAction();
          }
        },

        resetAction() {
          this.stopMic();
          this.setState("SETUP");
          this.el.recallInput.value = "";
          this.el.diffView.innerHTML = "";
          this.el.scorePill.classList.remove("visible");
        },

        setState(s) {
          this.state = s;

          if (s === "SETUP") {
            this.el.targetInput.disabled = false;
            this.el.targetOverlay.classList.remove("active");

            this.el.recallInput.style.display = "block";
            this.el.recallInput.disabled = true;
            this.el.recallInput.placeholder = "Click 'Start Recall' to type here...";

            this.el.btnMain.textContent = "Start Recall";
            this.el.btnMain.className = "c-btn c-btn-main";
            this.el.btnMain.style.backgroundColor = "var(--primary)";
            this.el.diffView.classList.remove("active");
            this.el.btnEdit.disabled = false;
          } else if (s === "RECALL") {
            this.el.targetInput.disabled = true;
            this.el.targetOverlay.classList.add("active");

            this.el.recallInput.style.display = "block";
            this.el.recallInput.disabled = false;
            this.el.recallInput.placeholder = "Type or speak your answer here...";

            this.el.btnMain.textContent = "Check Answer";
            this.el.btnMain.className = "c-btn c-btn-main";
            this.el.btnMain.style.backgroundColor = "var(--success)";
            this.el.diffView.classList.remove("active");
            this.el.btnEdit.disabled = true;
          } else {
            // REVIEW
            // Reveal Target Answer
            this.el.targetInput.disabled = true;
            this.el.targetOverlay.classList.remove("active"); // Hide Curtain

            this.el.recallInput.style.display = "none";

            this.el.btnMain.textContent =
              this.mode === "bulk" ? "Next Card ‚ñ∂" : "Retry";
            this.el.btnMain.style.backgroundColor = "var(--primary)";
            this.el.diffView.classList.add("active");
            this.el.scorePill.classList.add("visible");
            this.el.btnEdit.disabled = false;
          }

          this.el.btnMic.disabled = s !== "RECALL";
          this.updatePeek();
        },

        peekTarget() {
          if (this.ALLOW_PEEK) {
            this.el.targetOverlay.classList.toggle("active");
          }
        },

        updatePeek() {
          const allowed = this.ALLOW_PEEK;
          this.el.targetOverlay.style.cursor = allowed
            ? "pointer"
            : "not-allowed";
          this.el.targetOverlay.innerText = allowed
            ? "üîí Target Hidden (Click to Peek)"
            : "üîí Target Hidden";
        },

        // --- IMPORT / EXPORT ---
        openUploadModal() {
          document.getElementById("upload-name").value = "";
          document.getElementById("upload-text").value = "";
          this.el.mUpload.style.display = "flex";
        },

        processUpload() {
          try {
            const name = document.getElementById("upload-name").value.trim();
            const json = JSON.parse(
              document.getElementById("upload-text").value
            );
            const id = this.createDeck(name, json);
            if (id) this.openDeck(id);
          } catch (e) {
            alert("Invalid JSON");
          }
        },

        openCatalogModal() {
          const list = document.getElementById("catalog-list");
          list.innerHTML = "Loading...";
          fetch("catalogue.json")
            .then((r) => r.json())
            .then((d) => this.renderCatalogGrid(d, true))
            .catch(() => this.renderCatalogGrid(INTERNAL_CATALOG, false));
        },

        renderCatalogGrid(data, isExternal) {
          this.el.mCat.style.display = "flex";
          const list = document.getElementById("catalog-list");
          list.innerHTML = data
            .map(
              (d, i) => `
            <div class="catalog-item" onclick="app.importCatalog(${i}, ${isExternal}, '${
                d.filename
              }')">
                <div class="cat-title">${d.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${
                  isExternal ? "External File" : d.data.length + " Cards"
                }</div>
            </div>
        `
            )
            .join("");
          this.catalogCache = data;
        },

        async importCatalog(idx, isExternal, filename) {
          const meta = this.catalogCache[idx];
          const fname = isExternal ? filename : meta.filename;

          if (!isExternal) {
            const id = this.createDeck(meta.name, meta.data, meta.filename);
            if (id) this.openDeck(id);
          } else {
            try {
              const path = fname.includes("/") ? fname : "decks/" + fname;
              const res = await fetch(path);
              if (!res.ok) throw new Error("File not found");
              const json = await res.json();
              const id = this.createDeck(meta.name, json, fname);
              if (id) this.openDeck(id);
            } catch (e) {
              alert("Load failed: " + e.message);
            }
          }
          this.closeModals();
        },

        shareActiveDeck() {
          if (this.activeDeck) {
            if (this.activeDeck.filename)
              this.shareDeck(this.activeDeck.id);
            else this.exportDeck(this.activeDeck.id);
          }
        },

        shareDeck(id) {
          const deck = this.library.find((d) => d.id === id);
          if (!deck.filename)
            return alert("This is a user deck. Use Export instead.");
          const url =
            window.location.href.split("?")[0] + "?deck=" + deck.filename;
          prompt("Copy this Short Link to share:", url);
        },

        exportDeck(id) {
          const deck = this.library.find((d) => d.id === id);
          const mini = deck.cards.map((c) => ({
            prompt: c.prompt,
            target: c.target,
          }));
          const json = JSON.stringify(mini, null, 2);
          document.getElementById("upload-name").value = deck.name;
          document.getElementById("upload-text").value = json;
          this.el.mUpload.style.display = "flex";
          setTimeout(() => {
            document.getElementById("upload-text").select();
            document.execCommand("copy");
            alert("Deck JSON copied to clipboard!");
          }, 100);
        },

        checkForURLImport() {
          const params = new URLSearchParams(window.location.search);
          if (params.has("deck")) {
            const filename = params.get("deck");
            this.fetchRemoteDeck(filename, true);
            return true;
          }
          return false;
        },

        // --- HELPERS ---
        viewActiveRevision() {
          if (this.activeDeck) this.viewRevision(this.activeDeck.id);
        },
        viewRevision(id) {
          const deck = this.library.find((d) => d.id === id);
          document.getElementById("rev-title").textContent =
            "Review: " + deck.name;
          document.getElementById("rev-body").innerHTML = deck.cards
            .map(
              (c) =>
                `<tr><td style="font-weight:600; width:30%;">${c.prompt}</td><td>${c.target}</td></tr>`
            )
            .join("");
          this.el.mRev.style.display = "flex";
        },

        // 1. Save to LocalStorage and Render
        addToHistory(t, s, html) {
          const history = JSON.parse(
            localStorage.getItem("recall_session_history") || "[]"
          );
          history.unshift({
            id: Date.now(),
            t: t,
            s: s,
            html: html,
            d: new Date().toLocaleString([], { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            }), 
          });
          localStorage.setItem(
            "recall_session_history",
            JSON.stringify(history.slice(0, 50))
          );
          this.loadHistory();
        },

        // 2. Render the Table
        loadHistory() {
        const history = JSON.parse(localStorage.getItem("recall_session_history") || "[]");
        const tbody = document.getElementById("history-body");
        tbody.innerHTML = "";

        history.forEach((item, index) => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <!-- This column now displays the Date & Time string we saved -->
                <td style="font-size:0.85rem; color:#64748b; white-space:nowrap;">${item.d}</td>
                <td title="${item.t.replace(/"/g, "&quot;")}">
                    ${item.t.substring(0, 30)}${item.t.length > 30 ? '...' : ''}
                </td>
                <td style="color:${item.s >= 80 ? "var(--success)" : "var(--danger)"}; font-weight:bold;">
                    ${item.s}%
                </td>
                <td style="text-align:right;" class="action-btns">
                    <button onclick='app.viewHistoryItem(${index})' style="border:none; background:none; cursor:pointer; margin-right:5px;">View</button>
                    <button onclick='app.retakeHistoryItem(${index})' style="border:none; background:none; cursor:pointer; margin-right:5px;">Retake</button>
                    <button onclick='app.deleteHistoryItem(${index})' style="color:var(--danger); border:none; background:none; cursor:pointer;">Delete</button>
                </td>
            `;
        });
    },

        clearHistory() {
          if (confirm("Clear all session history?")) {
            localStorage.removeItem("recall_session_history");
            this.loadHistory();
          }
        },

        deleteHistoryItem(index) {
          const history = JSON.parse(
            localStorage.getItem("recall_session_history")
          );
          history.splice(index, 1);
          localStorage.setItem(
            "recall_session_history",
            JSON.stringify(history)
          );
          this.loadHistory();
        },

        viewHistoryItem(index) {
          const history = JSON.parse(
            localStorage.getItem("recall_session_history")
          );
          const item = history[index];
          document.getElementById("rev-title").textContent = "History Details";
          document.getElementById("rev-body").innerHTML = `
            <tr><td style="font-weight:bold; width:30%;">Target</td><td>${item.t}</td></tr>
            <tr><td style="font-weight:bold;">Result</td><td><div class="diff-view active" style="border:1px solid #eee; padding:10px;">${item.html}</div></td></tr>
        `;
          this.el.mRev.style.display = "flex";
        },

        retakeHistoryItem(index) {
          const history = JSON.parse(
            localStorage.getItem("recall_session_history")
          );
          const item = history[index];
          this.el.targetInput.value = item.t;
          this.resetAction();
          this.el.targetInput.scrollIntoView({ behavior: "smooth" });
        },

        closeModals() {
          document
            .querySelectorAll(".modal-overlay")
            .forEach((m) => (m.style.display = "none"));
        },

        // --- SCORING (LCS) ---
        calculateScore() {
          const t = this.el.targetInput.value;
          const i = this.el.recallInput.value;
          const norm = (s) =>
            s
              .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, "")
              .toLowerCase()
              .trim()
              .split(/\s+/)
              .filter((w) => w);
          const tW = norm(t),
            iW = norm(i);

          const sim = (a, b) => {
            if (a === b) return 1;
            if (Math.abs(a.length - b.length) > 3) return 0;
            const m = [];
            for (let x = 0; x <= a.length; x++) m[x] = [x];
            for (let y = 0; y <= b.length; y++) m[0][y] = y;
            for (let x = 1; x <= a.length; x++)
              for (let y = 1; y <= b.length; y++)
                m[x][y] = Math.min(
                  m[x - 1][y] + 1,
                  m[x][y - 1] + 1,
                  m[x - 1][y - 1] + (a[x - 1] === b[y - 1] ? 0 : 1)
                );
            const s =
              1.0 - m[a.length][b.length] / Math.max(a.length, b.length);
            return s >= 0.7 ? s : 0;
          };

          const dp = Array(tW.length + 1)
            .fill()
            .map(() => Array(iW.length + 1).fill(0));
          for (let r = 1; r <= tW.length; r++)
            for (let c = 1; c <= iW.length; c++)
              dp[r][c] =
                sim(tW[r - 1], iW[c - 1]) > 0
                  ? sim(tW[r - 1], iW[c - 1]) + dp[r - 1][c - 1]
                  : Math.max(dp[r - 1][c], dp[r][c - 1]);

          let r = tW.length,
            c = iW.length,
            fb = [],
            score = 0;
          while (r > 0 || c > 0) {
            const s = r > 0 && c > 0 ? sim(tW[r - 1], iW[c - 1]) : 0;
            if (r > 0 && c > 0 && s > 0) {
              fb.unshift({ s: "correct", txt: iW[c - 1], tgt: tW[r - 1] });
              score += s;
              r--;
              c--;
            } else if (c > 0 && (r === 0 || dp[r][c - 1] >= dp[r - 1][c])) {
              fb.unshift({ s: "extra", txt: iW[c - 1] });
              c--;
            } else {
              fb.unshift({ s: "missing", tgt: tW[r - 1] });
              r--;
            }
          }

          const pct = Math.max(0, Math.round((score / (tW.length || 1)) * 100));

          const html = fb
            .map((f) => {
              if (f.s === "correct")
                return `<span class="diff-correct">${f.txt}</span>`;
              if (f.s === "extra")
                return `<span class="diff-extra">${f.txt}</span>`;
              return `<span class="diff-missing" data-word="${f.tgt}">${f.tgt}</span>`;
            })
            .join(" ");

          this.el.diffView.innerHTML = html;
          this.el.scorePill.innerHTML = `<span style="color:${
            pct >= 80 ? "var(--success)" : "var(--danger)"
          }">${pct}%</span>`;

          if (this.mode === "single") {
            this.addToHistory(t, pct, html);
          } else {
            this.activeDeck.cards[this.currentCardIndex].score = pct;
            this.saveLibrary();
          }
        },

        // --- MIC (Mobile Fix) ---
        initSpeech() {
          if (!("webkitSpeechRecognition" in window)) {
            this.el.btnMic.style.display = "none";
            return;
          }

          const r = new webkitSpeechRecognition();
          r.continuous = true;
          r.interimResults = true;
          r.lang = "en-US";

          r.onstart = () => {
            this.isRecording = true;
            this.el.btnMic.classList.add("recording");
          };

          r.onend = () => {
            this.isRecording = false;
            this.el.btnMic.classList.remove("recording");
          };

          r.onresult = (e) => {
            let finalChunk = "";
            for (let i = e.resultIndex; i < e.results.length; ++i) {
              if (e.results[i].isFinal) {
                finalChunk += e.results[i][0].transcript;
              }
            }
            if (finalChunk) {
              const cur = this.el.recallInput.value;
              const spacing = cur && !cur.endsWith(" ") ? " " : "";
              this.el.recallInput.value = cur + spacing + finalChunk;
              this.el.recallInput.scrollTop = this.el.recallInput.scrollHeight;
            }
          };

          this.recognition = r;

          this.el.btnMic.onclick = () => {
            if (this.isRecording) r.stop();
            else {
              this.el.recallInput.focus();
              r.start();
            }
          };
        },
        stopMic() {
          if (this.isRecording) this.recognition.stop();
        },
      };

      app.init();
    </script>
  </body>
</html>